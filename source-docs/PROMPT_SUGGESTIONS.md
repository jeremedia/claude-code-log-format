# Prompt Suggestions (Claude Code v2.0.69)

Prompt suggestions are the contextual "tab to accept" chips that appear in Claude Code's UI after a response completes.

## How It Works

### Not Local - API Generated

Suggestions are **not** generated by a local LLM embedded in the binary. They're generated via a **fork query** - a separate API call that runs in the background.

### Generation Flow

```
User prompt completes
    ↓
FyB() checks if suggestions enabled
    ↓
Ci1() forks conversation context
    ↓
API call with prompt: "You are now a prompt suggestion generator.
                       The conversation above is context - your job
                       to suggest what Claude could help with next."
    ↓
Response text becomes suggestion
    ↓
Wi1() filters bad suggestions (too long, formatting, etc.)
    ↓
Stored in state: promptSuggestion: { text, shownAt, acceptedAt }
    ↓
UI displays with " (tab to accept)" suffix
```

### Key Functions (minified names from v2.0.69)

| Function | Purpose |
|----------|---------|
| `FyB` | Main suggestion handler, checks if enabled |
| `Ci1` | Makes the fork query to generate suggestions |
| `Gi1` | Constant containing the suggestion prompt |
| `Wi1` | Filters out bad suggestions |
| `SDR` | Generic fork query executor |

### Feature Flag

```javascript
Hi1 = "tengu_prompt_suggestion"  // Feature flag name
xDR = false                       // Runtime enable state
```

Controlled by:
- Environment variable: `CLAUDE_CODE_ENABLE_PROMPT_SUGGESTION`
- Feature flag system (checked at startup via `$4(Hi1)`)

### Suggestion Filtering (Wi1)

Suggestions are suppressed if they match any of these patterns:

| Check | Condition |
|-------|-----------|
| `empty` | No text |
| `done` | Text is literally "done" |
| `too_long` | >= 100 characters |
| `has_formatting` | Contains `\n`, `*`, or `**` |
| `error_message` | Contains "prompt is too long", "context length", "token limit" |
| `gratitude` | Contains "thanks", "thank you", "looks good", "that worked", "that's all" |

### Telemetry

```javascript
o("tengu_prompt_suggestion", {
  outcome: "accepted" | "ignored" | "suppressed",
  reason: "...",           // If suppressed
  timeToAcceptMs: 1234,    // If accepted
  timeToIgnoreMs: 1234,    // If ignored
  similarity: 0.85         // Ratio of user input to suggestion length
})
```

### Client State Shape

```typescript
interface PromptSuggestion {
  text: string | null;     // The suggestion text
  shownAt: number;         // Timestamp when displayed (0 if not shown yet)
  acceptedAt: number;      // Timestamp when user pressed Tab (0 if not accepted)
}
```

## Implications for Kyomei Nada

### Capturing Suggestions

The proxy captures the fork query as a normal API request. To identify suggestion queries:

1. Look for short message chains (context + suggestion prompt)
2. The prompt contains "prompt suggestion generator"
3. Response is typically 1-2 sentences

### Not a Dedicated Field

The suggestion is NOT in a special response field like `suggestedUserResponses`. It's just the text content from Claude's response to the fork query.

### Association Challenge

Fork queries don't have obvious parent-child relationships in the API. Would need heuristics:
- Same session ID prefix
- Close timestamps
- Short response length

## Search Patterns for Future Updates

```bash
# Find suggestion-related code
grep -E "prompt.*suggestion|suggestion.*generator" /tmp/claude-*.strings

# Find feature flags
grep -E "tengu_prompt" /tmp/claude-*.strings

# Find fork query sources
grep -E "querySource.*suggestion|forkLabel" /tmp/claude-*.strings
```

## Version History

| Version | Changes |
|---------|---------|
| v2.0.69 | Current documented version |
